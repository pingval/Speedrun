# [ゼノギアス セーブデータ改竄RTA in 19:49](https://www.youtube.com/watch?v=OTb3aogFcIM)

- プレイ日時: 2020年1月29日
- 計測区間: 本体の電源投入からTHE ENDが完全表示されるまで
- 使用ソフト:
  - RPGツクール3
  - ゼノギアス
- 使用本体: PS2(SCPH-90000)
  - アニメティカのみディスク読み込み速度「高速」使用
  - ゼノギアスでは高速読み込み無効([PSドライバ2.00のSCPH-90000では無効になるため](https://www.youtube.com/watch?v=TvKFy7Wxbrk))
- 使用コントローラ: Sony SCPH-10010
- 改ざん用のセーブデータ作成を計測区間に含める（事前に作成したセーブデータの利用は禁止！）
- RTAで使用するブロックの書き込みを終えるまで、アニメティカ無圧縮セーブ中のメモリーカードの抜き差しは禁止
  - ゼノギアスの場合、`7-1=6`なので無圧縮セーブ中「残り 6ブロック」と表示されたらメモリーカードを引き抜いてよい

----

## 戦略概要

- アニメティカで、現在のマップをEDムービーにあたるマップ(MapID: 0x41)に、現在のDISCもDISC 2に改竄する。
- SCPH-90000ではゼノギアスに高速読み込みが適用されないので、電源投入直後のリセットは行わない(適用対象がアニメティカのみでも高速読み込みを入れたほうが速いため、高速読み込み設定自体は行う)。
- `00`埋めとズームのカット
- **PS2本体のメモリーカード間コピー機能を利用した管理ブロック改竄**

### `00`埋めとズームのカット

アニメティカを開いた直後の真っ白なキャンバスは値`01`で埋まっている状態。今までやってきたゲームではその状態のキャンバスに描き込むのは具合が悪かったため、描き込む前にまず`00`で埋めていた。しかしゼノギアスの場合はどうやらそのまま描き込んだ方が速くできるようなので、**`00`埋めの工程をカット**した。

ゼノギアスでは描き込む必要のある座標はキャンバスのずっと右のほうにある。ズームする場合は右に大きくスクロールするロスが発生するため、思い切って**ズーム自体もカット**してみた。ズームを行わない等倍画面の場合、座標合わせは**ガチのピクセルパーフェクト**が要求されるため困難だが、まあ、開始後たった1mの地点だし通れば速い。

### PS2本体のメモリーカード間コピー機能を利用した管理ブロック改竄

自分が今までアニメティカを使ってとてもひどいことをしてきたゲームは全て、セーブ時にメモリーカードへ書き込む順序が
1. 管理ブロックにゲームの製品番号
2. データブロックにセーブデータの中身

だった。だがゼノギアスでは

1. 管理ブロックに`__tmp_file`の文字列
2. データブロックにセーブデータの中身
3. 改めて、管理ブロックにゲームの製品番号

となっている。困ったことに、***この書き込み順では、セーブ中のメモリーカード引き抜きによる強制中断によって管理ブロックだけを書き換えることが原理的に不可能***である。最初に`__tmp_file`の文字列へ書き換えられた瞬間に引き抜いても、そのセーブデータはゼノギアスで読み込めない。かといって最後にゲームの製品番号へ書き換えられたときには、既にデータブロックまでゼノギアスのセーブデータへ書き換え済みだからだ。

そこで登場するのがPS2本体のブラウザ。ブラウザでメモリーカードを開き、ゼノギアスのセーブデータを作ったメモリーカードから、アニメティカのセットアップを済ませたメモリーカードへコピーする。このとき***コピー開始直後にどちらかのメモリーカードを引き抜けば、コピー先予定の管理ブロックだけが書き換えられる。その引き抜き猶予はなんと約1.2s***。フレーム(f)じゃなくて秒(s)だよ。

メモリーカードが2枚必要となるものの、これを利用すれば、ゼノギアスのようにセーブ時の書き込み順が特殊なゲームでもなんでもお構いなく、管理ブロックの書き換えが非常に容易に行える。

どうやらPS2本体ブラウザのコピー機能は以下のようになっているようで、工程2の長い処理時間がそのまま引き抜き猶予になっているようだ。
1. 管理ブロックのみコピー。
2. コピー元のデータブロックを全て読み込む。
3. 読み込んだデータをコピー先のデータブロックに書き込む。

引き抜きが遅れた場合、
- コピー元を引き抜く: コピー先のデータブロックにコピー元のデータが全て書き込まれる。
- コピー先を引き抜く: コピー先のデータブロックへの書き込みは途中で中断される。

今回のRTAにおける具体的な手順は、
1. セーブ直前にPS2のトレイを開き、セーブしながらDISC 2に交換する。
2. セーブデータの書き込み完了直後(ブログレスバーが75%と残りの2/3まで進んだらOK)にPS2をリセットする
3. 「Sony Computer Entertainment」の文字が暗くなりだしたら一瞬だけトレイを開けて閉める(メニュー画面を表示させずに直接ブラウザを開くため)。
4. ブラウザが開いた直後にもう片方のメモリーカードを挿入する(メモリーカード読み込みロスをなくすため)。
5. ○ボタン連打でコピーを開始し、直後にコピー元のメモリーカードを引き抜く(コピー元を抜けばメモリーカードが自動で閉じられるため)。
6. 右入力＆○ボタン連打でDISC 2を読み込む。

……と、ロスを削減しようと試行錯誤した結果[やたら手元が忙しい区間](https://www.twitch.tv/videos/543630005?t=00h06m30s)となってしまった。

### セーブデータ詳細

```
0x4003: 01 ;; セーブデータの消費ブロック数 00だとロード画面でセーブデータを選択できない
0x4120..0x4140辺り: 01で埋まっているとロード画面で固まるため01以外で適当に埋める(詳細不明)

0x52d8: 01 ;; 00: DISC 1, 01: DISC 2
0x5c1f: 00 41 ;; 現在のMapID(EDムービー): 65
0x5fff: 0x4100..0x511eのチェックサム(和)
```

以下の色塗りを採用した。何も描いていないマスは`00`ではなく`01`で埋まっている点に注意。x座標26を変に埋めているのは、ロード画面フリーズ回避とチェックサム調整を兼ねている。

```
AnimeMaker(used block: #2):
  29: (222, 50)
  00: (223, 50)
  00: (251..287, 26)
Visual:
y\x|222223                                                                                 251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287
---+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 26|                                                                                        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 50| 29 00                                                                                                                                                                                                
```

なおパレット情報の混在する1ブロック目を使ってEDに直行できるセーブデータを作れないかも試してみたが、どうもムリそうだ。

----

## タイムいろいろ

|区間名|通過|区間|戦闘|備考|
|:---:|:---:|:---:|:---:|:---:|
|電源投入|00:00:00|||
|アニメティカ終了|00:01:31|00:01:31|||
|セーブ後リセット|00:06:39|00:05:08|||
|エンディング終了|00:19:49|00:13:10|||

- 計測地点:
  - アニメティカ終了: アニメティカ起動中にリセットした瞬間
  - エンディング終了: THE ENDが完全表示された瞬間

----

## 実際のプレイ

- アニメティカに手間取りすぎ。10s以上遅れてるかもしれない。
- 本気で連打していないし(本気でやっても遅いけど)、連打が必要となる箇所の調査が必要だろう。

----

## おわりに

- [PS2本体のコピー機能](http://www.palantir-k.net/palawiki/index.php?%E3%82%BC%E3%83%8E%E3%82%AE%E3%82%A2%E3%82%B9%2F%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%86%E3%82%A3%E3%82%AB#rd2819e5)に行き着いた[Palantir](https://twitter.com/Palantir_K)氏はやばい。アニメティカ使用のレースやタイマントーナメントなどの一発勝負や各種調査プレイにも役立つに違いないテク。
- 冒頭にも書いたが[PSドライバ2.00のSCPH-90000では高速読み込みがゼノギアスに適用されない](https://www.youtube.com/watch?v=TvKFy7Wxbrk)。SCPH-50000かなんかを使うのがベストなんだろうけども、めんどいのでそこまではやらない。

----

## 参考

- [プレイステーション・ＰＡＤ／メモリ・インターフェースの解析](http://kaele.com/~kashima/games/ps_jpn.txt)
- [RPGツクール3を使ったPS1セーブデータの改ざん方法 | RTAPlay!](https://rta-play.info/tool/save-glitch/)
- [Comparison of model differences for Xenogears - YouTube](https://www.youtube.com/watch?v=TvKFy7Wxbrk)
- [記録集 | うぐらぼ](http://liveug.web.fc2.com/xenogears/speedrun/records.htm)
- [ゼノギアス/アニメティカ - Palantir's Wiki](http://www.palantir-k.net/palawiki/index.php?%E3%82%BC%E3%83%8E%E3%82%AE%E3%82%A2%E3%82%B9%2F%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%86%E3%82%A3%E3%82%AB)
- [ゼノギアス　アニメティカ使用データ改竄方法:じぐぞぅのブロマガ - ブロマガ](https://ch.nicovideo.jp/Jiguzoooo/blomaga/ar1849949)
