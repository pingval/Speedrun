# [PS版FF9 セーブデータ改竄RTA in 21:11](https://www.youtube.com/watch?v=hZw2SbPTatA)

- プレイ日時: 2019年07月21日
- 計測区間: 本体の電源投入からエンドロゴ消滅まで
- 使用ソフト:
  - RPGツクール3
  - PS版FF9
- 使用本体: PS2(SCPH-90000)
  - FF9でディスク読み込み速度「高速」使用
- 使用コントローラ: Sony SCPH-10010
- 改ざん用のセーブデータ作成を計測区間に含める（事前に作成したセーブデータの利用は禁止！）
- アニメティカでの8ブロックセーブ中のメモリーカードの抜き差しは禁止（事前に作成したセーブデータを利用できる怖れがあるため）

----

## 戦略概要

- アニメティカで、現在のマップを途中からエンディングが再生されるマップ(MapID?: 3011)に、現在のDISCもDISC 4に改竄する。
- FF9でNEW GAMEを選択後なるべく早くセーブし、途中でメモリーカードを引き抜く。そのデータをロードすると、エンディングムービーから再開される。
- 謎の仮面男戦は全滅による速やかな戦闘終了を図る。
- 高速読み込み有無の比較はしていないが、高速読み込みを使用した。
- メモリーカードの引き抜きタイミングはBGMのBPMに合わせるとちょうどよい。FF7や8と違って引き抜きタイミングはかなり速い。
- FF9のエンディングムービーは単一のファイルっぽいので、ロード後のパートは短縮不可能だろう。

### セーブデータ詳細

以下のアドレスの中身は必須。これら以外は好きに変更して良い(はず)
```
0x4100..0x4103: 05 00 03 00
0x4104: 現在のDISC: x & 07 == 0 && x & 08 != 0 ;; x & 0f == 0 の場合、DISC番号チェックをスキップ
0x4110..0x4176: いずれかにff(文字列終端マーク)が必要
0x4180: 04 ;; 01だとEDムービー前の会話から
0x41a0..0x41a1: c3 0b ;; 現在のMapID?: 3011
0x53fe..0x53ff: 0x4000..0x53fd のチェックサム(CRC16/MCRF4XX)
```
- チェックサムのアルゴリズムはCRC16/MCRF4XX。crchackに渡すオプションは`-w16 -p1021 -iffff -x0000 -rR`。0に調整する。
- 現在のDISCは`N`bit目のフラグがDISC`N`に対応している(複数のフラグが立っている場合、より下位のフラグが優先される)。

| DISC | フラグ(16進数) | フラグ(2進数) |
| :---: | :---: | :---: |
| 1 | 01 | 00000001 |
| 2 | 02 | 00000010 |
| 3 | 04 | 00000100 |
| 4 | 08 | 00001000 |
- `0x4110..0x4176`はメモリーカード画面で表示される文字列。文字列終端マークの`ff`がない場合、**メモリーカードを開くとPS2がフリーズする**。
- `0x4000`に書き込まれた時点でチェックサムに影響が出てしまうため、メモリーカード引き抜き猶予時間は2f(たぶん)。

以下の色塗りを採用した。
```
  FF: ( 17, 27)
  04: ( 32, 27)
  C3: ( 63..64, 27)
  0B: ( 65, 27)
  05: (191..192, 26)
  03: (194, 26..27)
  18: (196, 26)
```
[その他の色塗り候補](./checksum0-disc.txt)

### DISC交換画面スキップ(DISC読み込み途中で交換)

現在のDISCの値を下位4bitが立たない値(`00`や`f0`など)に変更すると、DISC番号チェックがスキップされ、DISC交換画面が出ないまま進む。この仕様を利用すると「現在のDISCの色塗り」と「DISC交換画面」がスキップできる分短縮が期待できる。いつDISCを交換するかが問題になるが、メモリーカード選択画面が表示されたタイミングで、データをロードしながら交換すればよい。交換にモタついてると暗転から復帰しないが。
```
  FF: ( 11, 27)
  04: ( 32, 26)
  04: ( 32..33, 27)
  C3: ( 64, 27)
  0B: ( 65, 27)
  05: (192, 26..27)
  03: (194, 26)
```
[その他の色塗り候補](./checksum0-nodisc.txt)

----

## タイムいろいろ

|区間名|通過|区間|戦闘|備考|
|:---:|:---:|:---:|:---:|:---:|
|電源投入|00:00:00|||
|アニメティカ終了|00:02:07|00:02:07|||
|メモリーカード引き抜き|00:10:44|00:08:37|||
|エンディング終了|00:21:11|00:10:27|||

- 計測地点:
  - アニメティカ終了: アニメティカ起動中にリセットした瞬間

----

## 実際のプレイ

- 謎の仮面男戦は敵の行動1回。
- セーブ後のデータ確認で多少ｇｄる。

----

## おわりに

- いわゆる[ムービーカット](http://www.ne.jp/asahi/personal/heaven/ltt/ff/9/ta/tareport.html)ができないか何度か試したができなかった。SCPH-90000ではできなくなっているのかな？
- 実機だと`0x4110..0x4176`の範囲内に`ff`がないとフリーズするが、検証に使っていたNO$PSXでは`0x4177..0x417b`の範囲内にあってもフリーズしなかった。実機とエミュレータの違いに手間取った。
- 次はDQ4かFF789。

----

## 参考

- [プレイステーション・ＰＡＤ／メモリ・インターフェースの解析](http://kaele.com/~kashima/games/ps_jpn.txt)
- [RPGツクール3を使ったPS1セーブデータの改ざん方法 | RTAPlay!](https://rta-play.info/tool/save-glitch/)
- [巡回冗長検査 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%B7%A1%E5%9B%9E%E5%86%97%E9%95%B7%E6%A4%9C%E6%9F%BB)
- [resilar/crchack: Reversing CRC for fun and profit](https://github.com/resilar/crchack)
- [Memoria](http://forums.qhimm.com/index.php?topic=11494.0)
- [Luzbelheim - Final Fantasy IX JP [9:14:17] - Twitch](https://www.twitch.tv/videos/423962133)
